<html>
<head>
<title>User script generator</title>
<script language="javascript">
// todo: support before/after/replace injection
// todo: allow regex for trigger pattern
// todo: allow configuring user script headers (description, namespace,...)
// todo: persist and reload fields with cookies
// todo: make it easy for the user to include icons in the user script
// todo: support more tags (@@TITLE, @@VALUE)
// todo: support richer matching

// Copyright (c) 2005, Julien Couvreur
// Released under the GPL license
// http://www.gnu.org/copyleft/gpl.html

function toggle(targetId){
  if (document.getElementById){
        target = document.getElementById(targetId);
           if (target.style.display == "none"){
              target.style.display = "";
           } else {
              target.style.display = "none";
           }
     }
} 

function UserException (message) {
   this.message=message;
   this.name="UserException";
}

function generate() {
    try {
        // parse the text from "template" and generate a script
        var generatedSource = compile();

        // put it in the "generatedSource"
        document.getElementById("generatedSource").value = generatedSource;
        
        // put it in the "generatedLink" in "data:" format
        makeDataUrl();
        
        // create a link that matches the trigger and run the script
        makeExampleLink();
    }
    catch (e) 
    {
        document.getElementById("generatedSource").value = "Javascript error: " + e.message;
    }
}

function run() {
    eval(document.getElementById("generatedSource").value);
}

function compile() {
    var HrefToken = "@@HREF"
    var EOL = "\r\n";
    
    var template = document.getElementById("template").value;
    
    var tokenIndex = template.indexOf(HrefToken);
    if (tokenIndex == -1) {
        throw new UserException("@@HREF token not found in source");
    }
    var firstHalf = template.substring(0, tokenIndex);
    var secondHalf = template.substring(tokenIndex + HrefToken.length);
    firstHalf = firstHalf.replace(/\"/g, '\\"');
    secondHalf = secondHalf.replace(/\"/g, '\\"');
    
    var trigger = document.getElementById("triggerPattern").value;
    trigger = trigger.replace(/\./, '\\\.');
    var freeformCode = document.getElementById("freeformSource").value;
    
    var outputSource = 
"// ==UserScript==" + EOL +
"// @name            " + document.getElementById("scriptName").value + EOL +
"// @namespace       " + document.getElementById("scriptNamespace").value + EOL +
"// @description     " + document.getElementById("scriptDescription").value + EOL +
"// @include         *" + EOL +
"// @exclude         " + EOL +
"// ==/UserScript==" + EOL +
"// Generated by: http://blog.monstuff.com/archives/images/GreaseMonkeyScriptGenerator.html" + EOL + EOL +
"(function() {" + EOL +
"   // freeform code goes here" + EOL +
(freeformCode ? (freeformCode + EOL + EOL) : EOL) + 
"   // iterate over links and add template" + EOL +
"   var orig_page_links = document.links;" + EOL +
"   var page_links = new Array(orig_page_links.length);" + EOL +
"   for (var i=0; i < page_links.length; i++){" + EOL +
"       page_links[i] = orig_page_links[i];" + EOL +
"   }" + EOL +
"   for (var i=0; i < page_links.length; i++){" + EOL +
"       if (page_links[i].href.match(/" + trigger + "$/i)) {" + EOL +
"           var span = document.createElement('span');" + EOL +
"           var code_str = \"" + firstHalf + "\";" + EOL +
"           code_str += page_links[i].href;" + EOL +
"           code_str += \"" + secondHalf + "\";" + EOL +
"           span.innerHTML = code_str;" + EOL +
"           page_links[i].parentNode.insertBefore(span, page_links[i].nextSibling);" + EOL +
"       }" + EOL +
"   }" + EOL +
"})();" + EOL +
"";
    
    return outputSource;
}

function makeDataUrl() {
    //alert(btoa(document.getElementById("generatedSource").value));
    document.getElementById("generatedLink").href = 
        "data:text/javascript;charset=utf-8," + 
        encodeURI(document.getElementById("generatedSource").value + "//.user.js");
}

function makeExampleLink() {
    var trigger = document.getElementById("triggerPattern").value;
    document.getElementById("testlink").innerHTML = "<a href='test" + trigger + "' onclick='alert(\"This is only an example link.\");return false;'>example " + trigger + " link</a>";
}


</script>
</head>
<body onload="toggle('freeformSource');toggle('metainfo');makeExampleLink();">
This page allows you to generate GreaseMonkey scripts to insert an element of html after each link matching a certain pattern in the pages you visit.<br/>
It is a generalization of the <a href="http://webjay.org/geeklog-1.3.8-1sr2/public_html/forum/viewtopic.php?forum=6&showtopic=1499">inline mp3 player user script</a>.
<hr>
<p class="source">
Script metadata (<a onclick="toggle('metainfo');" href="#">Show/Hide</a>):<br />
<p id="metainfo">
Name:<br/>
<input id="scriptName" type=text maxlength=30 value="MyCustomUserScript"/><br />
Namespace:<br/> 
<input id="scriptNamespace" type=text maxlength=30 value="" /><br />
Description:<br/> 
<input id="scriptDescription" type=text maxlength=30 value=""/><br />
Pages that will trigger this script:<br/>
<textarea id="scriptIncludes" rows=7 cols=50 ></textarea><br/>
Pages that should never trigger this script:<br/>
<textarea id="scriptExcludes" rows=7 cols=50 ></textarea>
</p>
<p class="freeform">
Free-form script (<a onclick="toggle('freeformSource');" href="#">Show/Hide</a>):<br />
<textarea id="freeformSource" rows=7 cols=50 NAME="freeformSource"></textarea><br />
</p>
<p class="patterns">
File extension to match: <input id=triggerPattern type=text maxlength=20 value=".torrent" /><br />
Desired html that will be injected next to the matched links:<br/>
<textarea id=template rows=7 cols=50> <a href="@@HREF"><img src="data:image/gif;base64,R0lGODdhMAAwAPAAAAAAAP///ywAAAAAMAAwAAAC8IyPqcvt3wCcDkiLc7C0qwyGHhSWpjQu5yqmCYsapyuvUUlvONmOZtfzgFzByTB10QgxOR0TqBQejhRNzOfkVJ+5YiUqrXF5Y5lKh/DeuNcP5yLWGsEbtLiOSpa/TPg7JpJHxyendzWTBfX0cxOnKPjgBzi4diinWGdkF8kjdfnycQZXZeYGejmJlZeGl9i2icVqaNVailT6F5iJ90m6mvuTS4OK05M0vDk0Q4XUtwvKOzrcd3iq9uisF81M1OIcR7lEewwcLp7tuNNkM3uNna3F2JQFo97Vriy/Xl4/f1cf5VWzXyym7PHhhx4dbgYKAAA7" /></a></textarea><br />
Use @@HREF as a replacement tag for the url of the matched link. <br />
</p>

<button onclick="generate()">Generate user script</button> <br />
</p>
<hr>

<p class="output">
Here is an example link for the file extension you want to target: <span id="testlink"></span> <br/>
Test your user script on the example link: <button onclick="makeExampleLink();run()" ID="Button1">Run</button><br />
Install <a id=generatedLink href="" target="_blank">your user script</a>.<br />
<br/>
<textarea id=generatedSource rows=20 cols=100></textarea>
</p>

<a href="http://software.hixie.ch/utilities/cgi/data/data" target=_blank>How to include images in my user script?</a> (using data: url format)<br />
Here is <a href="data:image/gif;base64,R0lGODdhMAAwAPAAAAAAAP///ywAAAAAMAAwAAAC8IyPqcvt3wCcDkiLc7C0qwyGHhSWpjQu5yqmCYsapyuvUUlvONmOZtfzgFzByTB10QgxOR0TqBQejhRNzOfkVJ+5YiUqrXF5Y5lKh/DeuNcP5yLWGsEbtLiOSpa/TPg7JpJHxyendzWTBfX0cxOnKPjgBzi4diinWGdkF8kjdfnycQZXZeYGejmJlZeGl9i2icVqaNVailT6F5iJ90m6mvuTS4OK05M0vDk0Q4XUtwvKOzrcd3iq9uisF81M1OIcR7lEewwcLp7tuNNkM3uNna3F2JQFo97Vriy/Xl4/f1cf5VWzXyym7PHhhx4dbgYKAAA7">one example</a>.

</body>
</html>