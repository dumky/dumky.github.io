<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />

<title>Curiosity is bliss: Better async programming in .Net</title>

<link rel="stylesheet" href="http://blog.monstuff.com/styles-site.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://blog.monstuff.com/index.rdf" />

<link rel="start" href="http://blog.monstuff.com/" title="Home" />
<link rel="prev" href="http://blog.monstuff.com/archives/000369.html" title="Action, preferences, value" />

<link rel="next" href="http://blog.monstuff.com/archives/000371.html" title="Head Mounted Displays" />



<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-74363-1";
urchinTracker();
</script>

<script type="text/javascript" language="javascript">
<!--

function OpenTrackback (c) {
    window.open(c,
                    'trackback',
                    'width=480,height=480,scrollbars=yes,status=yes');
}

var HOST = 'blog.monstuff.com';

// Copyright (c) 1996-1997 Athenia Associates.
// http://www.webreference.com/js/
// License is granted if and only if this entire
// copyright notice is included. By Tomer Shiran.

function setCookie (name, value, expires, path, domain, secure) {
    var curCookie = name + "=" + escape(value) + ((expires) ? "; expires=" + expires.toGMTString() : "") + ((path) ? "; path=" + path : "") + ((domain) ? "; domain=" + domain : "") + ((secure) ? "; secure" : "");
    document.cookie = curCookie;
}

function getCookie (name) {
    var prefix = name + '=';
    var c = document.cookie;
    var nullstring = '';
    var cookieStartIndex = c.indexOf(prefix);
    if (cookieStartIndex == -1)
        return nullstring;
    var cookieEndIndex = c.indexOf(";", cookieStartIndex + prefix.length);
    if (cookieEndIndex == -1)
        cookieEndIndex = c.length;
    return unescape(c.substring(cookieStartIndex + prefix.length, cookieEndIndex));
}

function deleteCookie (name, path, domain) {
    if (getCookie(name))
        document.cookie = name + "=" + ((path) ? "; path=" + path : "") + ((domain) ? "; domain=" + domain : "") + "; expires=Thu, 01-Jan-70 00:00:01 GMT";
}

function fixDate (date) {
    var base = new Date(0);
    var skew = base.getTime();
    if (skew > 0)
        date.setTime(date.getTime() - skew);
}

function rememberMe (f) {
    var now = new Date();
    fixDate(now);
    now.setTime(now.getTime() + 365 * 24 * 60 * 60 * 1000);
    setCookie('mtcmtauth', f.author.value, now, '', HOST, '');
    setCookie('mtcmtmail', f.email.value, now, '', HOST, '');
    setCookie('mtcmthome', f.url.value, now, '', HOST, '');
}

function forgetMe (f) {
    deleteCookie('mtcmtmail', '', HOST);
    deleteCookie('mtcmthome', '', HOST);
    deleteCookie('mtcmtauth', '', HOST);
    f.email.value = '';
    f.author.value = '';
    f.url.value = '';
}

//-->
</script>



<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="http://blog.monstuff.com/archives/000370.html">
<dc:title>Better async programming in .Net</dc:title>
<dc:description><![CDATA[Better support for asynchronous programming was announced for C# 5.0 and a preview version has been released. It adds two new keywords, async and await, which enable the following programming model: async Task&lt;SomeResult> MyMethodAsync() { &nbsp; SomeResult result = ... &nbsp; try { &nbsp; &nbsp; foreach (...) { &nbsp; &nbsp; &nbsp; var data = await SomeAsyncMethod(); &nbsp; &nbsp; &nbsp; result.Add(data); &nbsp; &nbsp; } &nbsp; } catch (...) &nbsp; return result; } Task&lt;Data> SomeAsyncMethod() {...} This seems a very elegant solution, as the code reflects the desired execution sequence without unnatural callback methods. In particular, it greatly simplifies exception handling and...]]></dc:description>
<dc:creator>Julien</dc:creator>
<dc:date>2010-10-28T23:18:12-08:00</dc:date>
<license rdf:resource="http://creativecommons.org/licenses/by-sa/1.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-sa/1.0/">
<requires rdf:resource="http://web.resource.org/cc/Attribution" />
<requires rdf:resource="http://web.resource.org/cc/Notice" />
<requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
<permits rdf:resource="http://web.resource.org/cc/Reproduction" />
<permits rdf:resource="http://web.resource.org/cc/Distribution" />
<permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
</License>
</rdf:RDF>
-->



</head>

<body>

<div id="banner">
<h1><a href="http://blog.monstuff.com/" accesskey="1">Curiosity is bliss</a></h1>
<span class="description">Julien Couvreur's programming blog and more</span>
</div>

<div id="container">

<div class="blog">







<div id="menu">
<a href="http://blog.monstuff.com/archives/000369.html">« Action, preferences, value</a>&nbsp;&nbsp; 

| &nbsp;&nbsp;<a href="/archives.html">Archive list</a>&nbsp;&nbsp;
| &nbsp;&nbsp;<a href="http://blog.monstuff.com/archives/000380.html">Thick displays</a> (latest)

</div>

</div>

<div class="blog">

<!-- <h2 class="date">October 28, 2010</h2> -->




<div class="blogbody">
<!-- google_ad_section_start -->

<h2 class="title">Better async programming in .Net</h2>

<p>Better support for asynchronous programming was <a href="http://blogs.msdn.com/b/pfxteam/archive/2010/10/27/10081944.aspx">announced for C# 5.0</a> and a preview version has been released.<br />
It adds two new keywords, async and await, which enable the following programming model:</p>

<div class="code">
async Task&lt;SomeResult> MyMethodAsync() {

<p>&nbsp; SomeResult result = ...</p>

<p>&nbsp; try {</p>

<p>&nbsp; &nbsp; foreach (...) {</p>

<p>&nbsp; &nbsp; &nbsp;   var data = await SomeAsyncMethod();</p>

<p>&nbsp; &nbsp; &nbsp;   result.Add(data);</p>

<p>&nbsp; &nbsp; }</p>

<p></p>

<p>&nbsp; } catch (...)</p>

<p>&nbsp; return result;</p>

<p>}</p>

<p>Task&lt;Data> SomeAsyncMethod() {...}<br />
</div></p>

<p>This seems a very elegant solution, as the code reflects the desired execution sequence without unnatural callback methods. In particular, it greatly simplifies exception handling and other call structures (loops and such). Also, it builds upon the Task class introduced in NetFx and later officially included into C# 4.0.</p>

<p>Under the covers, the method above get compiled with tricks similar to iterators: capturing the local variables of the method into an object to maintain state when the method yields control away, and using a state machine to model the structure of the method and it's various interruption/continuation points. </p>

<p>When the first "await" keyword is reached, the method returns a Task object, holding the promise of a future result. <br />
In the case of iterators, the method would resume after the "yield" statement the next time the GetNext() method would be called again. <br />
But in the case of async methods, the code after "await" executes as a callback of the inner asynchronous operation (SomeAsyncMethod in the example above). Subsequent await statements are also translated into callbacks.<br />
When a "return" statement is reached, as the end of this chain of callbacks, the Task which was handed to the caller completes and finally delivers its result.</p>

<p></p>

<p>As it stands, you can only use "await" in methods marked with "async". But I don't understand why the "async" keyword is needed, as it seems that the compiler could recognize such methods by the presence of the "await" keyword in the body of the method. (Update: here's <a href="http://blogs.msdn.com/b/ericlippert/archive/2010/11/11/whither-async.aspx">why</a>)</p>

<p><object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="512" height="288"><br />
<param name="source" value="http://channel9.msdn.com/scripts/VideoPlayer.xap?v=3.1" /><br />
<param name="initParams" value="deferredLoad=true,duration=0,m=http://ecn.channel9.msdn.com/o9/ch9/f903/b4d164fc-0901-4f2f-8deb-9e150113f903/MadsTorgersenInsideAsync_ch9.wmv,autostart=false,autohide=true,showembed=true, thumbnail=http://ecn.channel9.msdn.com/o9/ch9/f903/b4d164fc-0901-4f2f-8deb-9e150113f903/MadsTorgersenInsideAsync_512_ch9.jpg, postid=0" /><br />
<param name="background" value="#00FFFFFF" /><br />
<a href="http://go.microsoft.com/fwlink/?LinkID=124807" style="text-decoration: none;"><br />
<img src="http://go.microsoft.com/fwlink/?LinkId=108181" alt="Get Microsoft Silverlight" style="border-style: none"/><br />
</a><br />
</object></p>

<p>See the <a href="http://msdn.com/vstudio/async">Async page on MSDN</a> for more videos and a whitepaper on this feature.</p>

<a name="more"></a>


<span class="posted">Posted by Julien on October 28, 2010. <a href="http://blog.monstuff.com/archives/000370.html" rel="bookmark">Permalink</a> <!-- -->
<br /></span>

</div>



<div class="comments-head"><a name="comments"></a>Comments</div>

<div class="comments-body">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'curiosityisbliss'; 
        var disqus_identifier = '370';
        var disqus_url = 'http://blog.monstuff.com/archives/000370.html';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>    





<div class="comments-body">
<p>Personally, I really do hate the direction, C# is going. More half-baked stuff added in each subsequent version.</p>
<span class="comments-post">Posted by: <a href="http://www.zeta-uploader.com">Uwe</a> at December  6, 2010 01:47 PM</span>
</div>



<div class="comments-head"><a name="trackbacks"></a>Trackbacks</div>



<!-- google_ad_section_end -->

<div class="comments-body">
<!--
Comments are closed. You can <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#106;&#117;&#108;&#105;&#101;&#110;&#46;&#99;&#111;&#117;&#118;&#114;&#101;&#117;&#114;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">contact me by email</a>. 
-->
</div>


</div>
</div>

<!-- google_ad_section_start(weight=ignore) -->
<div id="links">

<div class="sidetitle">
Recent Entries
</div>

<div class="side">
<a href="/archives.html">All entries (270)</a><br />
<br />

<a href="http://blog.monstuff.com/archives/000380.html">Thick displays</a><br />
<a href="http://blog.monstuff.com/archives/000377.html">Hans Rosling on the facts about population</a><br />
<a href="http://blog.monstuff.com/archives/000376.html">Bill Nye and Ken Ham debating on creationism</a><br />
<a href="http://blog.monstuff.com/archives/000375.html">Prediction vs Explanation</a><br />
<a href="http://blog.monstuff.com/archives/000374.html">Protectionism == Luddism</a><br />
<a href="http://blog.monstuff.com/archives/000373.html">Moderated off Boing Boing</a><br />
<a href="http://blog.monstuff.com/archives/000372.html">I &#9829; Patent Trolls</a><br />
<a href="http://blog.monstuff.com/archives/000371.html">Head Mounted Displays</a><br />
<a href="http://blog.monstuff.com/archives/000370.html">Better async programming in .Net</a><br />
<a href="http://blog.monstuff.com/archives/000369.html">Action, preferences, value</a><br />
<a href="http://blog.monstuff.com/archives/000368.html">Fresh breeze on climate debate</a><br />
<a href="http://blog.monstuff.com/archives/000367.html">On-the-fly book scanning</a><br />
<a href="http://blog.monstuff.com/archives/000366.html">State and education</a><br />
<a href="http://blog.monstuff.com/archives/000365.html">Live Geometry screencast</a><br />
<a href="http://blog.monstuff.com/archives/000364.html">Wired Science TV show</a><br />
<a href="http://blog.monstuff.com/archives/000362.html">Expectations and accountability in Economics</a><br />
<a href="http://blog.monstuff.com/archives/000361.html">Science of human action</a><br />
<a href="http://blog.monstuff.com/archives/000359.html">Reactive programming in javascript and C#</a><br />
<a href="http://blog.monstuff.com/archives/000358.html">Google Wave</a><br />
<a href="http://blog.monstuff.com/archives/000357.html">Reading facial expressions</a><br />

</div>
<!-- google_ad_section_end -->

</body>
</html>
