<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />

<title>Curiosity is bliss: Secure cooperation in javascript</title>

<link rel="stylesheet" href="http://blog.monstuff.com/styles-site.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://blog.monstuff.com/index.rdf" />

<link rel="start" href="http://blog.monstuff.com/" title="Home" />
<link rel="prev" href="http://blog.monstuff.com/archives/000315.html" title="Implementing threads in javascript" />

<link rel="next" href="http://blog.monstuff.com/archives/000318.html" title="Frustration with RIA platforms" />



<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-74363-1";
urchinTracker();
</script>

<script type="text/javascript" language="javascript">
<!--

function OpenTrackback (c) {
    window.open(c,
                    'trackback',
                    'width=480,height=480,scrollbars=yes,status=yes');
}

var HOST = 'blog.monstuff.com';

// Copyright (c) 1996-1997 Athenia Associates.
// http://www.webreference.com/js/
// License is granted if and only if this entire
// copyright notice is included. By Tomer Shiran.

function setCookie (name, value, expires, path, domain, secure) {
    var curCookie = name + "=" + escape(value) + ((expires) ? "; expires=" + expires.toGMTString() : "") + ((path) ? "; path=" + path : "") + ((domain) ? "; domain=" + domain : "") + ((secure) ? "; secure" : "");
    document.cookie = curCookie;
}

function getCookie (name) {
    var prefix = name + '=';
    var c = document.cookie;
    var nullstring = '';
    var cookieStartIndex = c.indexOf(prefix);
    if (cookieStartIndex == -1)
        return nullstring;
    var cookieEndIndex = c.indexOf(";", cookieStartIndex + prefix.length);
    if (cookieEndIndex == -1)
        cookieEndIndex = c.length;
    return unescape(c.substring(cookieStartIndex + prefix.length, cookieEndIndex));
}

function deleteCookie (name, path, domain) {
    if (getCookie(name))
        document.cookie = name + "=" + ((path) ? "; path=" + path : "") + ((domain) ? "; domain=" + domain : "") + "; expires=Thu, 01-Jan-70 00:00:01 GMT";
}

function fixDate (date) {
    var base = new Date(0);
    var skew = base.getTime();
    if (skew > 0)
        date.setTime(date.getTime() - skew);
}

function rememberMe (f) {
    var now = new Date();
    fixDate(now);
    now.setTime(now.getTime() + 365 * 24 * 60 * 60 * 1000);
    setCookie('mtcmtauth', f.author.value, now, '', HOST, '');
    setCookie('mtcmtmail', f.email.value, now, '', HOST, '');
    setCookie('mtcmthome', f.url.value, now, '', HOST, '');
}

function forgetMe (f) {
    deleteCookie('mtcmtmail', '', HOST);
    deleteCookie('mtcmthome', '', HOST);
    deleteCookie('mtcmtauth', '', HOST);
    f.email.value = '';
    f.author.value = '';
    f.url.value = '';
}

//-->
</script>



<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="http://blog.monstuff.com/archives/000316.html">
<dc:title>Secure cooperation in javascript</dc:title>
<dc:description>Today&apos;s web programming environment suffers from a cooperation problem. One illustration is that if you include a foreign script into your page, you are compromising the security of your page. In other words, it difficult to compose functionality while remaining confident that the different components will not abuse each other. A solution found in the desktop world is to build a complicated set of restrictions around your code: ACLs, permissions, sandbox rules, checks and policies. I would argue that it is not working great for the desktop and is definitely not practical for the web. Alternatively, the proponents of capability-based...</dc:description>
<dc:creator>Julien</dc:creator>
<dc:date>2007-04-04T09:26:57-08:00</dc:date>
<license rdf:resource="http://creativecommons.org/licenses/by-sa/1.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-sa/1.0/">
<requires rdf:resource="http://web.resource.org/cc/Attribution" />
<requires rdf:resource="http://web.resource.org/cc/Notice" />
<requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
<permits rdf:resource="http://web.resource.org/cc/Reproduction" />
<permits rdf:resource="http://web.resource.org/cc/Distribution" />
<permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
</License>
</rdf:RDF>
-->



</head>

<body>

<div id="banner">
<h1><a href="http://blog.monstuff.com/" accesskey="1">Curiosity is bliss</a></h1>
<span class="description">Julien Couvreur's programming blog and more</span>
</div>

<div id="container">

<div class="blog">







<div id="menu">
<a href="http://blog.monstuff.com/archives/000315.html">« Implementing threads in javascript</a>&nbsp;&nbsp; 

| &nbsp;&nbsp;<a href="/archives.html">Archive list</a>&nbsp;&nbsp;
| &nbsp;&nbsp;<a href="http://blog.monstuff.com/archives/000380.html">Thick displays</a> (latest)

</div>

</div>

<div class="blog">

<!-- <h2 class="date">April 04, 2007</h2> -->




<div class="blogbody">
<!-- google_ad_section_start -->

<h2 class="title">Secure cooperation in javascript</h2>

<p>Today's web programming environment suffers from a cooperation problem. One illustration is that if you include a foreign script into your page, you are compromising the security of your page. In other words, it difficult to compose functionality while remaining confident that the different components will not abuse each other.</p>

<p>A solution found in the desktop world is to build a complicated set of restrictions around your code: ACLs, permissions, sandbox rules, checks and policies. I would argue that it is not working great for the desktop and is definitely not practical for the web.<br />
 <br />
Alternatively, the proponents of <a href="http://erights.org/">capability-based security</a> advocate an approach based on a simpler set of primitives: encapsulating all authority into objects, ensuring that components can keep data and references private, and the ability to start executing some code with a controlled set of references to pre-existing objects (the default being none, by principle of least authority).</p>

<p>Javascript already has a way of keeping private variables (local variables using "var") and doesn't allow references to be forged. One missing element is a mechanism to invoke a function or evaluate a string in a controlled environment. This could include ways to sandbox function calls (including the <i>eval</i> method) and the &lt;script&gt; element.</p>

<a name="more"></a>
<p> <br />
Function calls could be made in a controlled environment, by introducing a new keyword, similar to the <i>with</i> primitive except that it would hide the rest of the scope chain. The code would look like this:</p>

<div class="code">var myScope = { obj1 = ... };

<p>function executeSensitiveCode() {<br />
&nbsp;&nbsp;  // this function can use obj1 or any other member of myScope<br />
&nbsp;&nbsp;  // this function code cannot see or modify the global scope (the "window" object)<br />
}</p>

<p>sandbox(myScope) { executeSensitiveCode(); } </div></p>

<p>A sandboxed &lt;script&gt; element would need a new tag name (so that it requires you to specify a scope factory method by default) and would look like this:</p>

<div class="code">&lt;script>
function buildMyScope() { 
&nbsp;&nbsp;  var myScope = { obj1 = ... }; 
&nbsp;&nbsp;  return myScope; 
} 
&lt;/script>

<p>&lt;sandboxedscript src=".../sensitive.js" sandbox="buildMyScope()" /></div><br />
 <br />
 <br />
Having such primitives for safe javascript cooperation would be a great step forward, but would only be a start. Other improvements would need to appear over time.</p>

<p>First, most sandboxed code will need access to some default and safe primitives such as the String or Array constructors. But in javascript this lets the sandboxed code modifiy these functions, for example hijacking some of their prototype methods. The sandbox should prevent this somehow, thus safeguarding the caller's environment from tampering.</p>

<p>Second, some large objects and APIs such as the DOM are dangerous because they cannot be segmented easily. The problem is illustrated when I want to pass in a DOM element into my sandbox, but doing so in effect passes references to the entire DOM tree. The developer would need some convenient way of building <a href="http://cap-lore.com/CapTheory/Patterns/Facet.html">facets</a> to such APIs.</p>

<p>Finally, the sandboxing solution protects the caller from the sandboxed code, but does not help protecting the sandboxed code from the caller. The caller can mess with the environment expected by the invoked code. Solving this scenario would simplify developing components such as the <a href="http://dev.live.com/contactscontrol">Windows Live Contacts Control</a>, where content returned from a remote location needs to be kept secret from the host page. Currently, this can only be achieved by using iframes and a <a href="http://blog.monstuff.com/archives/000304.html">url hash hack</a>, but I hope that a better solution could be designed.</p>

<p><h4>Update (2007/10/02):</h4> Doug Crockford gave a talk on the topic, which is available for streaming: <a href="http://video.google.com/videoplay?docid=452089494323007214">Gears and the Mashup problem</a>.<br />
He summarizes the limitations of Javascript's security model, then proposes extending the Google Gear WorkerPool concept to provide a sound security model. The WorkerPool would provide isolation between modules and cooperation between modules would be allowed and controlled thru channels.</p>

<p><h4>Update (2008/02/23):</h4> <a href="http://ben.adida.net/">Ben Adida</a> proposed a similar javascript extension, <a href="http://seclab.cs.rice.edu/w2sp/2007/slides/Adida-loosely-coupled-mashups.pdf">with_cleanslate</a>, which would allow running code in a default and unpowerful scope. <br />
The "with_cleanstate" works for isolation, but is not great for fine-grained control. That is where the "sandbox" approach above would work better: it would give developers control of what APIs, powers or authorities to pass into the sandboxed scope.</p>

<p>Also worth keeping an eye on is the <a href="http://code.google.com/p/google-caja/">Google Caja</a> project. More to come on this soon (I have a post queued up on the topic).</p>

<span class="posted">Posted by Julien on April 04, 2007. <a href="http://blog.monstuff.com/archives/000316.html" rel="bookmark">Permalink</a> <!-- -->
<br /></span>

</div>



<div class="comments-head"><a name="comments"></a>Comments</div>

<div class="comments-body">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'curiosityisbliss'; 
        var disqus_identifier = '316';
        var disqus_url = 'http://blog.monstuff.com/archives/000316.html';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>    





<div class="comments-body">
<p>Nice thinking! One way to remedy the DOM issue is by converting all references to DOM nodes into DocumentFragments. At least that would minimize the DOM tree available.</p>

<p>That only leaves us with expando properties :)</p>
<span class="comments-post">Posted by: <a href="http://novemberborn.net/">Mark Wubben</a> at April  5, 2007 03:31 AM</span>
</div>



<div class="comments-head"><a name="trackbacks"></a>Trackbacks</div>



<!-- google_ad_section_end -->

<div class="comments-body">
<!--
Comments are closed. You can <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#106;&#117;&#108;&#105;&#101;&#110;&#46;&#99;&#111;&#117;&#118;&#114;&#101;&#117;&#114;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">contact me by email</a>. 
-->
</div>


</div>
</div>

<!-- google_ad_section_start(weight=ignore) -->
<div id="links">

<div class="sidetitle">
Recent Entries
</div>

<div class="side">
<a href="/archives.html">All entries (270)</a><br />
<br />

<a href="http://blog.monstuff.com/archives/000380.html">Thick displays</a><br />
<a href="http://blog.monstuff.com/archives/000377.html">Hans Rosling on the facts about population</a><br />
<a href="http://blog.monstuff.com/archives/000376.html">Bill Nye and Ken Ham debating on creationism</a><br />
<a href="http://blog.monstuff.com/archives/000375.html">Prediction vs Explanation</a><br />
<a href="http://blog.monstuff.com/archives/000374.html">Protectionism == Luddism</a><br />
<a href="http://blog.monstuff.com/archives/000373.html">Moderated off Boing Boing</a><br />
<a href="http://blog.monstuff.com/archives/000372.html">I &#9829; Patent Trolls</a><br />
<a href="http://blog.monstuff.com/archives/000371.html">Head Mounted Displays</a><br />
<a href="http://blog.monstuff.com/archives/000370.html">Better async programming in .Net</a><br />
<a href="http://blog.monstuff.com/archives/000369.html">Action, preferences, value</a><br />
<a href="http://blog.monstuff.com/archives/000368.html">Fresh breeze on climate debate</a><br />
<a href="http://blog.monstuff.com/archives/000367.html">On-the-fly book scanning</a><br />
<a href="http://blog.monstuff.com/archives/000366.html">State and education</a><br />
<a href="http://blog.monstuff.com/archives/000365.html">Live Geometry screencast</a><br />
<a href="http://blog.monstuff.com/archives/000364.html">Wired Science TV show</a><br />
<a href="http://blog.monstuff.com/archives/000362.html">Expectations and accountability in Economics</a><br />
<a href="http://blog.monstuff.com/archives/000361.html">Science of human action</a><br />
<a href="http://blog.monstuff.com/archives/000359.html">Reactive programming in javascript and C#</a><br />
<a href="http://blog.monstuff.com/archives/000358.html">Google Wave</a><br />
<a href="http://blog.monstuff.com/archives/000357.html">Reading facial expressions</a><br />

</div>
<!-- google_ad_section_end -->

</body>
</html>
