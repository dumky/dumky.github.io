<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />

<title>Curiosity is bliss: Closures & Continuations</title>

<link rel="stylesheet" href="http://blog.monstuff.com/styles-site.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://blog.monstuff.com/index.rdf" />

<link rel="start" href="http://blog.monstuff.com/" title="Home" />
<link rel="prev" href="http://blog.monstuff.com/archives/000240.html" title="&quot;MSDN Language Filter&quot; user script" />

<link rel="next" href="http://blog.monstuff.com/archives/000246.html" title="Textarea resize user script" />



<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-74363-1";
urchinTracker();
</script>

<script type="text/javascript" language="javascript">
<!--

function OpenTrackback (c) {
    window.open(c,
                    'trackback',
                    'width=480,height=480,scrollbars=yes,status=yes');
}

var HOST = 'blog.monstuff.com';

// Copyright (c) 1996-1997 Athenia Associates.
// http://www.webreference.com/js/
// License is granted if and only if this entire
// copyright notice is included. By Tomer Shiran.

function setCookie (name, value, expires, path, domain, secure) {
    var curCookie = name + "=" + escape(value) + ((expires) ? "; expires=" + expires.toGMTString() : "") + ((path) ? "; path=" + path : "") + ((domain) ? "; domain=" + domain : "") + ((secure) ? "; secure" : "");
    document.cookie = curCookie;
}

function getCookie (name) {
    var prefix = name + '=';
    var c = document.cookie;
    var nullstring = '';
    var cookieStartIndex = c.indexOf(prefix);
    if (cookieStartIndex == -1)
        return nullstring;
    var cookieEndIndex = c.indexOf(";", cookieStartIndex + prefix.length);
    if (cookieEndIndex == -1)
        cookieEndIndex = c.length;
    return unescape(c.substring(cookieStartIndex + prefix.length, cookieEndIndex));
}

function deleteCookie (name, path, domain) {
    if (getCookie(name))
        document.cookie = name + "=" + ((path) ? "; path=" + path : "") + ((domain) ? "; domain=" + domain : "") + "; expires=Thu, 01-Jan-70 00:00:01 GMT";
}

function fixDate (date) {
    var base = new Date(0);
    var skew = base.getTime();
    if (skew > 0)
        date.setTime(date.getTime() - skew);
}

function rememberMe (f) {
    var now = new Date();
    fixDate(now);
    now.setTime(now.getTime() + 365 * 24 * 60 * 60 * 1000);
    setCookie('mtcmtauth', f.author.value, now, '', HOST, '');
    setCookie('mtcmtmail', f.email.value, now, '', HOST, '');
    setCookie('mtcmthome', f.url.value, now, '', HOST, '');
}

function forgetMe (f) {
    deleteCookie('mtcmtmail', '', HOST);
    deleteCookie('mtcmthome', '', HOST);
    deleteCookie('mtcmtauth', '', HOST);
    f.email.value = '';
    f.author.value = '';
    f.url.value = '';
}

//-->
</script>



<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="http://blog.monstuff.com/archives/000243.html">
<dc:title>Closures &amp; Continuations</dc:title>
<dc:description>For some reason, closures and continuations are a topic that I regularly look into, and every time think I got it. Yet every time I dig into it again, I realize my understanding is still somewhat superficial and discover more. Sam Ruby just wrote an intro article to continuations. I found it a bit too hand-wavy to be really satisfying, but it made me want to completely get it this time ;-) I&apos;ve been re-reading my bookmarks and new pages on the topic, especially in the context of Scheme and Javascript. Today&apos;s post will stay rather general, summarizing what closures...</dc:description>
<dc:creator>Julien</dc:creator>
<dc:date>2005-04-15T16:00:19-08:00</dc:date>
<license rdf:resource="http://creativecommons.org/licenses/by-sa/1.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-sa/1.0/">
<requires rdf:resource="http://web.resource.org/cc/Attribution" />
<requires rdf:resource="http://web.resource.org/cc/Notice" />
<requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
<permits rdf:resource="http://web.resource.org/cc/Reproduction" />
<permits rdf:resource="http://web.resource.org/cc/Distribution" />
<permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
</License>
</rdf:RDF>
-->



</head>

<body>

<div id="banner">
<h1><a href="http://blog.monstuff.com/" accesskey="1">Curiosity is bliss</a></h1>
<span class="description">Julien Couvreur's programming blog and more</span>
</div>

<div id="container">

<div class="blog">







<div id="menu">
<a href="http://blog.monstuff.com/archives/000240.html">« "MSDN Language Filter" user script</a>&nbsp;&nbsp; 

| &nbsp;&nbsp;<a href="/archives.html">Archive list</a>&nbsp;&nbsp;
| &nbsp;&nbsp;<a href="http://blog.monstuff.com/archives/000380.html">Thick displays</a> (latest)

</div>

</div>

<div class="blog">

<!-- <h2 class="date">April 15, 2005</h2> -->




<div class="blogbody">
<!-- google_ad_section_start -->

<h2 class="title">Closures & Continuations</h2>

<p>For some reason, closures and continuations are a topic that I regularly look into, and every time think I got it. Yet every time I dig into it again, I realize my understanding is still somewhat superficial and discover more.<br />
Sam Ruby just wrote <a href="http://www.intertwingly.net/blog/2005/04/13/Continuations-for-Curmudgeons">an intro article to continuations</a>. I found it a bit too hand-wavy to be really satisfying, but it made me want to completely get it this time ;-)</p>

<p>I've been re-reading my bookmarks and new pages on the topic, especially in the context of Scheme and Javascript. <br />
Today's post will stay rather general, summarizing what closures and continuations are. <br />
I intend to write a more detailed post some time next week with more specifics of Javascript: closures, data and execution models (but not continuations, as they don't seem to exist in Javascript).</p>

<a name="more"></a>
<p><b>Closures:</b><br />
When you enter a new function, a new lexical scope is created. Each scope is something like an association table containing the local variables (name and value) and links back to its containing/outer/parent scope. When code needs to lookup an identifier, it will search that lexical environment, by iterating up that chain until it finds it.</p>

<p>A closure is a function object that references a specific inner scope (and thus the chain of its parent scopes too). It is said to "capture" that lexical scope. For example if define and return an inner function, it will reference that local scope. </p>

<p>Here's an example of closure, in Javascript.<br />
<div class="code">> var local = 5;<br />
> var foo = function() { var inner = 1; return local + inner; }<br />
> foo();<br />
6<br />
> var local = 10;<br />
> foo();<br />
11<br />
</div></p>

<p>Because a closure keeps a reference to a specific scope, even as the code exits that scope and starts creating new ones, the chains of lexical scope really build a tree. <br />
Two closures can close over the same scope, thus sharing state as it gets modified. Branches of that tree get "pruned" by the garbage collector, when nothing references them anymore.</p>

<p><b>Continuations:</b><br />
There is a second such chain which represents the chain of control (tracking which instruction you're at in a given function). When a function is called or an exception occurs that chain gets involved. For example, when a function is invoked, a new lexical scope is created and a marker is also added to the control chain.</p>

<p>If you take a chain of lexical variable scopes (as found in a closure) and associate it with a chain of control, you could use it these as the context for calling a routine. A continuation is a routine pointer with a lexical scope and a control chain. It captures a context of execution or "place in the code" (stack or stack-frame, lexical scope, and position within the function or method) so that one can return to that location in the code and resume execution from that point forward. Usually the lexical scope, control chain and instruction pointer (what to do next, when you invoke the continuation) are captured together.</p>

<p>All control structures can be implemented with continuations. For example, when you register an exception handler, you capture a continuation; when the exception is thrown that continuation is invoked and you just continue running from the spot in the exception handler (the instruction pointer in the continuation points to the entry of the exception handler).</p>

<p>In comparison, the execution model for C programs only allows a stack that holds both chains of lexical scope and control. Another difference is that that stack is implemented very efficiently, whereas keeping linked lists for the lexical scopes involves heap allocation and garbage collection. </p>

<p><b>Links:</b><br />
<ul><li>Based on Dan's post on <a href="http://www.sidhe.org/~dan/blog/archives/000156.html">closures and continuations</a>. </li><li>The <a href="http://www.squarefree.com/shell/">javascript shell</a> is really useful for trying out snippets of Javascript, and Edward Lee just improved it to better support multi-line input: <a href="http://ed.agadak.net/jsshell.php">multi-line shell</a>. </li></p>

<span class="posted">Posted by Julien on April 15, 2005. <a href="http://blog.monstuff.com/archives/000243.html" rel="bookmark">Permalink</a> <!-- -->
<br /></span>

</div>



<div class="comments-head"><a name="comments"></a>Comments</div>

<div class="comments-body">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'curiosityisbliss'; 
        var disqus_identifier = '243';
        var disqus_url = 'http://blog.monstuff.com/archives/000243.html';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>    





<div class="comments-body">
<p>Hi, I wrote a tortured entry about JavaScript continuations or continuations-passing-style in mozilla...</p>

<p><a href="http://levelplusplus.blogspot.com/2004/07/continuations-in-mozilla.html">http://levelplusplus.blogspot.com/2004/07/continuations-in-mozilla.html</a></p>
<span class="comments-post">Posted by: <a href="http://levelplusplus.blogspot.com/2004/07/continuations-in-mozilla.html">Steve Yen</a> at May  8, 2005 12:05 AM</span>
</div>



<div class="comments-head"><a name="trackbacks"></a>Trackbacks</div>



<!-- google_ad_section_end -->

<div class="comments-body">
<!--
Comments are closed. You can <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#106;&#117;&#108;&#105;&#101;&#110;&#46;&#99;&#111;&#117;&#118;&#114;&#101;&#117;&#114;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">contact me by email</a>. 
-->
</div>


</div>
</div>

<!-- google_ad_section_start(weight=ignore) -->
<div id="links">

<div class="sidetitle">
Recent Entries
</div>

<div class="side">
<a href="/archives.html">All entries (270)</a><br />
<br />

<a href="http://blog.monstuff.com/archives/000380.html">Thick displays</a><br />
<a href="http://blog.monstuff.com/archives/000377.html">Hans Rosling on the facts about population</a><br />
<a href="http://blog.monstuff.com/archives/000376.html">Bill Nye and Ken Ham debating on creationism</a><br />
<a href="http://blog.monstuff.com/archives/000375.html">Prediction vs Explanation</a><br />
<a href="http://blog.monstuff.com/archives/000374.html">Protectionism == Luddism</a><br />
<a href="http://blog.monstuff.com/archives/000373.html">Moderated off Boing Boing</a><br />
<a href="http://blog.monstuff.com/archives/000372.html">I &#9829; Patent Trolls</a><br />
<a href="http://blog.monstuff.com/archives/000371.html">Head Mounted Displays</a><br />
<a href="http://blog.monstuff.com/archives/000370.html">Better async programming in .Net</a><br />
<a href="http://blog.monstuff.com/archives/000369.html">Action, preferences, value</a><br />
<a href="http://blog.monstuff.com/archives/000368.html">Fresh breeze on climate debate</a><br />
<a href="http://blog.monstuff.com/archives/000367.html">On-the-fly book scanning</a><br />
<a href="http://blog.monstuff.com/archives/000366.html">State and education</a><br />
<a href="http://blog.monstuff.com/archives/000365.html">Live Geometry screencast</a><br />
<a href="http://blog.monstuff.com/archives/000364.html">Wired Science TV show</a><br />
<a href="http://blog.monstuff.com/archives/000362.html">Expectations and accountability in Economics</a><br />
<a href="http://blog.monstuff.com/archives/000361.html">Science of human action</a><br />
<a href="http://blog.monstuff.com/archives/000359.html">Reactive programming in javascript and C#</a><br />
<a href="http://blog.monstuff.com/archives/000358.html">Google Wave</a><br />
<a href="http://blog.monstuff.com/archives/000357.html">Reading facial expressions</a><br />

</div>
<!-- google_ad_section_end -->

</body>
</html>
