---
title: "Hosting a web browser component in a C# winform"
date: 2003-06-01 10:30:08 +0800
disqus_identifier: 52
disqus_url: http://blog.monstuff.com/archives/000052.html
---
{% raw %}
<p>Many winform applications need to render some html: blog aggregators, news/mail readers or any kind of application that wants to use html as their output facility (reporting tools, log analyzers,...).<br />
We'll go through the details of using the "Microsoft Web Browser" COM component in a C# winform, with and without VS.net. A couple of the most useful APIs will be explained and provided samples for.</p>
<p><b>Using VS.net</b><br />
Let's first get the browser component into the form.<br />
In the "Customize Toolbox..." context menu (on the Toolbox), pick "Microsoft Web Browser" from the COM components list. This will add an "Explorer" control in the "General" section of the Toolbox.<br />
You can drag and drop this control onto your form and voila !</p>

<p>With this control (named <i>axWebBrowser1</i> by the winform designer), you will be able to browse the web, but if you want to render your own (locally generated) HTML, you will also need some interfaces like <i>IHTMLDocument2</i> and <i>IHTMLElement</i>.<br />
To make these available, go to the "Add a Reference" wizard in the Solution Explorer and pick "Microsoft.mshtml" in the ".NET" tab.<br />
Adding the "using mshtml;" declaration to your code or using full class names (mshtml.IHTMLDocument2) will give you access to all the needed classes.</p>

<p><b>Using the command line only</b><br />
We now want to make these classes available, but to a command-line project (no VS.net help).</p>

<p>First, let's generate the interop dlls for the ActiveX browser component: SHDocVw.dll and AxSHDocVw.dll. This is what VS.net does (sliently) when you added this component to your toolbox.<br />
Run "aximp c:\WINNT\system32\shdocvw.dll".<br />
At this point you can compile a form that uses the <i>AxSHDocVw.AxWebBrowser</i> class, using "csc /r:SHDocVw.dll,AxSHDocVw.dll YourForm.cs".<br />
In the code, the "using AxSHDocVw;" statement will the classes available to you, or you can use the full class names (AxSHDocVw.*).</p>

<p>Now, to also make the <i>IHTMLDocument2</i> and <i>IHTMLElement</i> interfaces available to us, we need to generate an interop dll for the mshtml COM object.<br />
To do so, run "tlbimp c:\WINNT\system32\mshtml.tlb".<br />
Compiling the form now becomes "csc /r:SHDocVw.dll,AxSHDocVw.dll,MSHTML.dll YourForm.cs"</p>

<p>Note: it seems that the .NET framework already provides an interop dll for the mshtml COM object. It seems to be called a "primary interop dll", but I am not sure yet what it is or how to reference it. I'll add details here as I find them.</p>

<p><b>Programming the <i>AxSHDocVw.AxWebBrowser</i> control</b><br />
First let's load a web page. For this you just need to call the <i>Navigate</i> method like shown below:<br />
<div class="code">object o = null;<br />
axWebBrowser1.Navigate("http://google.com", ref o, ref o, ref o, ref o);<br />
</div></p>

<p>You'll notice that the <i>Navigate</i> method is asynchronous, ie. the call returns before the web page is completely loaded and displayed. You can get a notification of completion by registering to the <i>NavigateComplete2</i> event (with a <i>AxSHDocVw.DWebBrowserEvents2_NavigateComplete2EventHandler</i> handler).<br />
In the InitializeComponent() method generated by VS.net, or wherever you do your events hook-up, add: <br />
<div class="code">this.axWebBrowser1.NavigateComplete2 += new DWebBrowserEvents2_NavigateComplete2EventHandler(this.navigateComplete2);<br />
</div></p>

<p>Where your callback looks like:<br />
<div class="code">private void navigateComplete2(object sender, DWebBrowserEvents2_NavigateComplete2Event e)<br />
{<br />
// Page loaded<br />
}</div></p>

<p>This notification is useful because you can't feed your own html into the component until a page is loaded. To expedite this loading you can use the "about:blank" url instead of google's. <br />
Then, in the event handler (or in any code that gets executed only after the component has the blank page loaded) you can feed it your html with:<br />
<div class="code">private void navigateComplete2(object sender, DWebBrowserEvents2_NavigateComplete2Event e)<br />
{<br />
IHTMLDocument2 htmlDocument = (IHTMLDocument2)axWebBrowser1.Document;<br />
IHTMLElement body = (IHTMLElement)htmlDocument.body;</p>

<p>body.innerHTML = "&lt;html>&lt;body>hello world&lt;/body>&lt;/html>";<br />
}</div></p>

<p>You now have the ability to browse the web or display your own html, within your winform!</p>

<p><b>Memory considerations</b><br />
With my first attempt of embedding a browser in a winform, I got a 27Megs runtime memory usage for the winform. That seemed high so I looked at it some more.<br />
I got it down to 20Megs by removing all the un-necessary "using" statements that VS.net had generated for me.<br />
The overall break-down for the memory usage is as follows:<br />
- an empty winform with "using" cleanup: 11Megs,<br />
- a winform with cleanup and unused browser (no Navigate call): 15Megs,<br />
- a winform with cleanup and used browser: 19Megs.<br />
The numbers provided are approximate. Also, as with any GC system, the memory usage always seems higher than it really needs to be until the GC performs its collection, so it is difficult to know exactly what the memory usage is...</p>

<p><b>MissingManifestResourceException</b><br />
When I tried to compile and run the code from my VS.net project in the command-line, I got an exception:<br />
<div class="code">An unhandled exception of type 'System.Resources.MissingManifestResourceException' occurred in mscorlib.dll</p>

<p>Additional information: Could not find any resources appropriate for the specified culture (or the neutral culture) in the given assembly.  Make sure "Form1.resources" was correctly embedded or linked into assembly "Form1".<br />
baseName: Form1  locationInfo: BrowserTest.Form1  resource file name: Form1.resources  assembly: Form1, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null</div></p>

<p>I haven't found the exact reason for this exception, but I got ride of it by removing all references to "resources" from the code.</p>

<p><b>Links</b><br />
<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cptools/html/cpgrfwindowsformsactivexcontrolimporteraximpexe.asp">MSDN reference on aximp utility</a><br />
<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cptools/html/cpgrftypelibraryimportertlbimpexe.asp">MSDN reference on tlbimp utility</a><br />
An article on <a href="http://www.west-wind.com/presentations/aspnetruntime/aspnetruntime.asp">hosting the ASP.NET runtime in an application</a>.</p>

<p><u>Update:</u> I just found out a <a href="http://www.codeproject.com/csharp/webbrowser.asp?target=browser">codeproject article</a> that uses some more APIs of the WebBrowser component in C#. Unfortunately, after building and running the browser I wasn't able to actually use or see these features, except the "Edit" (pen icon).</p>

<p><u>Update (Oct 10, 2003):</u> <br />
<b>Binding the DOM and the winform</b><br />
One question I still had was about extending the scripting APIs available within the component. For example, if you display an html page in the browser component, how can javascript inside that page interact with the application/winform itself? It is possible, as described by this <a href="http://msdn.microsoft.com/workshop/browser/overview/overview.asp">page (MSDN)</a> and in this <a href="http://www.codeproject.com/csharp/winformiehost.asp">C# example (The Code Project)</a>. Here is <a href="http://www.codeproject.com/dotnet/dwebapp.asp">another C# example (The Code Project)</a>.</p>

<p>For example, if we include a button inside our html, we can bind a C# listener method to the click event for that html element, as the following code shows:</p>

<div class="code">private void navigateComplete2(object sender, DWebBrowserEvents2_NavigateComplete2Event e)

<p>{</p>

<p>&nbsp;IHTMLDocument2 htmlDocument = (IHTMLDocument2)axWebBrowser1.Document;<br />
&nbsp;IHTMLElement body = (IHTMLElement)htmlDocument.body;</p>

<p>&nbsp;body.innerHTML = "&lt;html>&lt;body>hello world  &lt;button id=buttonID>Click Me&lt;/button> &lt;/body>&lt;/html>";</p>

<p>&nbsp;HTMLButtonElement button = (HTMLButtonElement) htmlDocument.all.item("buttonID", null);</p>

<p>&nbsp;((HTMLButtonElementEvents2_Event) button).onclick += new HTMLButtonElementEvents2_onclickEventHandler(this.button_click);</p>

<p>}</p>

<p>private bool button_click(IHTMLEventObj e) <br />
{</p>

<p>&nbsp;MessageBox.Show("button clicked");<br />
&nbsp;return true;</p>

<p>}</div></p>

<p>This example shows how the C# world can manipulate the DOM. Doing the reverse, by giving the DOM world some access to C# methods and variables would be interesting too. I'm experimenting with it right now, following the article on the Code Project, but I am getting a 'null' error in the browser. The author mentions getting the same error (and spending two weeks to solve it), but didn't post the details of his solution...</p>

<p><b>Links:</b><br />
<a href="http://www.codeproject.com/csharp/mshtml_automation.asp">Browser automation in C#</a>.</p>

______________________________________

<p>I haven't had time to play with this (it requires a full Mozilla development environment), but it seems promising: a Gecko wrapper in managed C++.</p>

<p>You can find it at:<br />
<a href="http://lxr.mozilla.org/seamonkey/source/embedding/wrappers/DotNETEmbed/ManagedGecko.html">http://lxr.mozilla.org/seamonkey/source/embedding/wrappers/DotNETEmbed/ManagedGecko.html</a></p>

Posted by: <a href="http://blog.monstuff.com">Dumky</a> (June 20, 2003 12:19 PM)

______________________________________

<p>As a complement you can even host an ASP.Net runtime in your app, check this very detailled article out: <a href="http://www.west-wind.com/presentations/aspnetruntime/aspnetruntime.asp">http://www.west-wind.com/presentations/aspnetruntime/aspnetruntime.asp</a></p>

Posted by: <a href="http://blog.monstuff.com">Dumky</a> (June 29, 2003 12:00 AM)

______________________________________

<p>re: MissingManifestResourceException</p>

<p>Got this today and just couldn't believe it. Didn't even have a resource file (that i knew of). Thanks to Michael Covington (uga) for posting the underlying problem...</p>

<p>I had moved an enum def outside the Form class to the namespace. If you have a class def before the Form class the compiler gets confused (wrong resource file name?) and generates this exception.</p>

<p>details at <a href="http://www.ai.uga.edu/~mc/VisualStudioGotchas.html">http://www.ai.uga.edu/~mc/VisualStudioGotchas.html</a></p>

Posted by: <a href="http://www.ai.uga.edu/~mc/VisualStudioGotchas.html#Unhandled">Dhominator</a> (September  3, 2003 02:42 PM)

______________________________________

<p>re:</p>

<p>ha! lame explanation by MS... functioning as designed. Jah, right :p</p>

<p><a href="http://support.microsoft.com/?kbid=318603">http://support.microsoft.com/?kbid=318603</a></p>

Posted by: <a href="http://support.microsoft.com/?kbid=318603">Dhominator</a> (September  3, 2003 02:45 PM)

______________________________________

<p>same thing can i do with out using webbrowser control.is there anyway.please let me know the solution if there is</p>

Posted by: <a href="mailto&#58;praveenchand&#46;katragadda&#64;essit&#46;com">praveen</a> (November 24, 2004 02:17 AM)

______________________________________

<p>I want to do the same thing in asp.net but I don't know the way to access the property of web browser component. Plz Help</p>

<p>Amit Shrivastava </p>

Posted by: <a href="mailto&#58;amitvps_shri&#64;yahoo&#46;com">Amit Shrivastava</a> (June  2, 2005 11:06 PM)

______________________________________

<p>Other events are dead. It's imposible to write or click in html page....</p>

Posted by: <a href="http://-">NeK</a> (August 16, 2005 01:26 AM)

______________________________________

<p>With your example I was not able to assign "Hello world" string in NavigateComplete2 event handler because it seems that body object is not initialized yet.</p>

Posted by: <a href="mailto&#58;manovich&#64;gmail&#46;com">manovich</a> (October  1, 2005 04:16 AM)

______________________________________

<p>If you do at least one call to axWebBrowser1.Navigate() first (even with the url "about:blank") then the body will be initialized properly.</p>

Posted by: <a href="http://blog.monstuff.com/archives/000052.html">Jeff</a> (October 26, 2005 07:37 AM)

______________________________________

<p>How can I save the file to local disk as HTML that was loaded by Web Browser control? Thanks for the help.</p>

Posted by: <a href="mailto&#58;vijayabareddy&#64;gmail&#46;com">Vijay</a> (November  7, 2005 01:10 PM)

______________________________________

<p>don't call .Navigate() in the form's Onload event - this was causing the control to lock up on my system</p>

Posted by: <a href="http://www.freeweb.telco4u.net/lammy/">lammy</a> (December  7, 2005 02:29 AM)

______________________________________

<p>Just what I was looking for...  Thanks for the awesome explaination.</p>

Posted by: <a href="mailto&#58;a&#64;a&#46;com">a</a> (March  8, 2006 09:28 PM)



{% endraw %}